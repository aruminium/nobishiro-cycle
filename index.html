<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>あるみ式のびしろサイクル</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root {
      --bg-color: #fff6f9;
      --card-bg: #ffffff;
      --center-bg: #fffcef;
      --accent-color: #f5aac0;
      --text-color: #ee7d9b;
      --shadow-color: rgba(245, 170, 192, 0.3);
      --border-color: rgba(238, 125, 155, 0.2);
      --blue-accent: #7db9ee;
      --green-accent: #7deebb;
      --green-shadow: rgba(125, 238, 187, 0.3);
      --review-bg: #fef9e7; /* Light yellow for review */
      --review-border: #fbdc8e;
      --error-color: #ee7d7d;
    }
* {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Zen Maru Gothic', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      line-height: 1.6;
      padding: 20px;
      padding-bottom: 100px; /* Add padding for floating buttons */
      scroll-behavior: smooth;
      /* Ensure body takes up at least viewport height for screenshot */
      min-height: 100vh;
    }

    .container {
      max-width: 1000px;
      margin: 0 auto;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
    }

    .header h1 {
      font-size: 2.2rem;
      color: var(--text-color);
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1.1rem;
      color: var(--text-color);
      opacity: 0.8;
      max-width: 600px;
      margin: 0 auto;
    }

    /* Storage message */
    .storage-note {
      background-color: rgba(245, 170, 192, 0.1);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 15px;
      margin: 20px auto;
      max-width: 800px;
      font-size: 0.9rem;
      color: var(--text-color);
      text-align: center;
      display: none; /* Initially hidden, shown by JS if needed */
    }

    .storage-note p {
      margin: 5px 0;
    }

    /* Tabs Navigation */
    .tabs-nav {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px;
      margin-bottom: 30px;
    }

    .tab-button {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding: 12px 20px;
      background-color: var(--card-bg);
      color: var(--text-color);
      border: 1px solid var(--border-color);
      border-radius: 30px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px var(--shadow-color);
      display: flex;
      align-items: center;
      gap: 6px;
      touch-action: manipulation;
    }

    .tab-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px var(--shadow-color);
    }

    .tab-button.active {
      background-color: var(--accent-color);
      color: white;
      box-shadow: 0 4px 10px var(--shadow-color);
      transform: translateY(0);
    }

    /* Tab Content */
    .tab-content {
      background-color: var(--card-bg);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 8px 20px var(--shadow-color);
      margin-bottom: 40px;
      min-height: 60vh;
    }

    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
      animation: fadeIn 0.4s ease-out forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title {
      font-size: 1.8rem;
      color: var(--text-color);
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .section-description {
      font-size: 1rem;
      color: var(--text-color);
      opacity: 0.8;
      margin-bottom: 25px;
      max-width: 700px;
    }

    /* Cards Grid for AS-IS section */
    .asis-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
    }

    .card {
      background-color: var(--card-bg);
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 8px var(--shadow-color);
      transition: all 0.3s ease;
      border: 1px solid var(--border-color);
      height: 100%;
      display: flex;
      flex-direction: column;
    }

    .card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 15px var(--shadow-color);
    }

    .tobe-card {
      background-color: var(--center-bg);
      border-color: var(--accent-color);
    }

    .card-title {
      font-size: 1.2rem;
      font-weight: 500;
      margin-bottom: 8px;
      color: var(--text-color);
    }

    .card-subtitle {
      font-size: 0.95rem;
      color: var(--text-color);
      opacity: 0.8;
      margin-bottom: 15px;
    }

    textarea {
      width: 100%;
      min-height: 150px;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 10px;
      font-family: 'Zen Maru Gothic', sans-serif;
      resize: vertical;
      color: #555;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      flex-grow: 1;
    }

    textarea:focus {
      outline: none;
      border-color: var(--accent-color);
      box-shadow: 0 0 0 3px var(--shadow-color);
    }

    /* Navigation buttons */
    .tab-navigation {
      display: flex;
      justify-content: space-between;
      margin-top: 30px;
    }

    .nav-button {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding: 10px 20px;
      background-color: var(--blue-accent);
      color: white;
      border: none;
      border-radius: 30px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(125, 185, 238, 0.3);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 8px;
      touch-action: manipulation;
    }

    .nav-button:hover {
      background-color: #6baae0;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4);
    }

    .nav-button.prev {
      background-color: #aaa;
      box-shadow: 0 4px 8px rgba(170, 170, 170, 0.3);
    }

    .nav-button.prev:hover {
      background-color: #888;
      box-shadow: 0 6px 12px rgba(136, 136, 136, 0.4);
    }

    .nav-button.invisible {
      visibility: hidden;
    }

    /* Progress bar */
    .progress-container {
      margin: 0 auto 30px;
      width: 100%;
      max-width: 800px;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: rgba(245, 170, 192, 0.2);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background-color: var(--accent-color);
      width: 0%;
      transition: width 0.5s ease;
    }

    .progress-labels {
      display: flex;
      justify-content: space-between;
      margin-top: 10px;
      font-size: 0.8rem;
      color: var(--text-color);
      opacity: 0.8;
    }

    /* Floating Action Buttons Area */
    .fab-container {
        position: fixed;
        bottom: 20px;
        right: 20px;
        display: flex;
        flex-direction: column; /* Stack buttons vertically */
        gap: 10px; /* Space between buttons */
        z-index: 100;
    }

    .fab {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      padding: 10px 15px; /* Slightly smaller padding */
      color: white;
      border: none;
      border-radius: 30px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 0.9rem; /* Slightly smaller font */
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      width: auto;
      min-width: 120px; /* Ensure text fits */
      height: 40px; /* Fixed height */
      text-align: center;
      touch-action: manipulation;
    }

    .fab:hover {
      transform: translateY(-2px) scale(1.05);
    }

    /* Individual FAB styles */
    .save-button-local {
      background-color: var(--accent-color);
      box-shadow: 0 4px 10px var(--shadow-color);
    }
    .save-button-local:hover { box-shadow: 0 6px 12px var(--shadow-color); }

    .download-button {
      background-color: var(--blue-accent);
      box-shadow: 0 4px 10px rgba(125, 185, 238, 0.3);
    }
    .download-button:hover { box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); }

    .upload-button {
       background-color: var(--green-accent);
       box-shadow: 0 4px 10px var(--green-shadow);
    }
    .upload-button:hover { box-shadow: 0 6px 12px var(--green-shadow); }


    /* Hidden file input */
    #fileInput {
        display: none;
    }

    /* Notification */
    .notification {
      position: fixed;
      bottom: 150px; /* Adjust position above FABs */
      right: 20px;
      background-color: var(--accent-color);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 0.9rem;
      box-shadow: 0 4px 10px var(--shadow-color);
      transform: translateY(150px); /* Start further down */
      opacity: 0;
      transition: transform 0.4s ease-out, opacity 0.4s ease-out;
      z-index: 99;
      pointer-events: none;
    }
    .notification.upload-success {
        background-color: var(--green-accent);
        color: #333; /* Darker text for green bg */
        box-shadow: 0 4px 10px var(--green-shadow);
    }
    .notification.error {
        background-color: var(--error-color);
         box-shadow: 0 4px 10px rgba(238, 125, 125, 0.3);
    }


    .notification.show {
      transform: translateY(0);
      opacity: 1;
    }

     /* Action buttons within Check tab */
    .check-actions {
        display: flex;
        flex-wrap: wrap; /* Allow wrapping on smaller screens */
        justify-content: center;
        gap: 15px; /* Space between buttons */
        margin-top: 2rem;
        margin-bottom: 1.5rem; /* Space before next section */
    }
    .check-actions button {
      padding: 10px 20px;
      color: white;
      border: none;
      border-radius: 30px;
      font-family: 'Zen Maru Gothic', sans-serif;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex; /* Use inline-flex */
      align-items: center;
      gap: 8px;
    }
    .check-actions button:hover {
       transform: translateY(-2px);
    }
    #generate-image-btn {
        background-color: var(--blue-accent);
        box-shadow: 0 4px 8px rgba(125, 185, 238, 0.3);
    }
     #generate-image-btn:hover {
       background-color: #6baae0;
       box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4);
    }
     #generate-image-btn:disabled { background-color: #aaa; cursor: not-allowed; transform: none; box-shadow: none; }

    #reviewButton { /* New Review Button Style */
        background-color: var(--green-accent); /* Use green */
        color: #333; /* Darker text for green */
        box-shadow: 0 4px 8px var(--green-shadow);
    }
     #reviewButton:hover {
        background-color: #6bcdac; /* Darker green on hover */
        box-shadow: 0 6px 12px var(--green-shadow);
    }

    /* Review Summary Container */
    #review-summary-container {
        display: none; /* Hidden by default */
        margin-top: 2rem;
        padding: 25px;
        background-color: var(--review-bg);
        border: 1px solid var(--review-border);
        border-radius: 15px;
        box-shadow: 0 4px 10px rgba(251, 220, 142, 0.2);
        color: #555; /* Darker text for readability */
    }
    .review-section {
        margin-bottom: 20px;
    }
    .review-section:last-child {
        margin-bottom: 0;
    }
    .review-section-title {
        font-size: 1.3rem;
        font-weight: 500;
        color: var(--text-color); /* Use main text color for title */
        margin-bottom: 10px;
        padding-bottom: 5px;
        border-bottom: 1px dashed var(--accent-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .review-content {
        font-size: 0.95rem;
        line-height: 1.7;
        white-space: pre-wrap; /* Preserve line breaks and spaces */
        word-wrap: break-word; /* Break long words */
        background-color: rgba(255, 255, 255, 0.5); /* Slight white background */
        padding: 10px;
        border-radius: 8px;
        border: 1px solid rgba(238, 125, 155, 0.1);
    }
     .review-content.asis-item { /* Style for individual as-is items */
        margin-bottom: 10px;
        border-left: 3px solid var(--accent-color);
        padding-left: 15px;
     }
    .review-content.asis-item strong { /* Subtitle for as-is item */
        display: block;
        font-weight: 500;
        margin-bottom: 5px;
        color: var(--text-color);
        opacity: 0.9;
    }


    #review-image-container { display: none; text-align: center; margin-top: 1.5rem; background-color: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #review-image { max-width: 100%; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 1rem; }
    #review-image-container p { font-size: 0.9rem; margin-top: 1rem; color: var(--text-color); opacity: 0.9; line-height: 1.5; } /* Adjusted line-height */
    #tweet-btn { display: inline-block; margin-top: 1rem; padding: 10px 20px; background-color: #1DA1F2; color: white; border-radius: 30px; text-decoration: none; font-size: 1rem; font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(29, 161, 242, 0.3); }
    #tweet-btn:hover { background-color: #0c85d0; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(29, 161, 242, 0.4); }

    /* Responsive Styles */
    @media (max-width: 768px) {
        body { padding: 15px; padding-bottom: 120px; }
        .header h1 { font-size: 1.8rem; } .header p { font-size: 1rem; }
        .asis-grid { grid-template-columns: 1fr; }
        .section-title { font-size: 1.5rem; }
        .tab-button { font-size: 0.9rem; padding: 10px 15px; }
        .tab-content { padding: 20px; }
        .fab-container { right: 15px; bottom: 15px; }
        .fab { font-size: 0.85rem; padding: 8px 12px; min-width: 100px; height: 36px; gap: 5px; }
        .notification { font-size: 0.85rem; padding: 10px 15px; right: 15px; bottom: 150px; }
        #generate-image-btn, #tweet-btn, .nav-button, #reviewButton { font-size: 0.9rem; padding: 8px 16px; }
        .check-actions { gap: 10px; }
        .review-section-title { font-size: 1.2rem; }
        .review-content { font-size: 0.9rem; }
    }
    @media (max-width: 480px) {
        .header h1 { font-size: 1.6rem; }
        .tab-button { font-size: 0.85rem; padding: 8px 12px; }
        .fab { font-size: 0.8rem; min-width: 40px; width: 40px; height: 40px; border-radius: 50%; padding: 0; }
        .fab span { display: none; }
        .notification { width: calc(100% - 30px); left: 15px; right: 15px; text-align: center; bottom: 170px; }
        .check-actions button span { /* display: none; */ }
    }
    /* (基本スタイル - 省略) */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; padding: 20px; padding-bottom: 100px; scroll-behavior: smooth; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 30px; }
    .header h1 { font-size: 2.2rem; color: var(--text-color); margin-bottom: 10px; }
    .header p { font-size: 1.1rem; color: var(--text-color); opacity: 0.8; max-width: 600px; margin: 0 auto; }
    .storage-note { background-color: rgba(245, 170, 192, 0.1); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin: 20px auto; max-width: 800px; font-size: 0.9rem; color: var(--text-color); text-align: center; display: none; }
    .storage-note p { margin: 5px 0; }
    .tabs-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 30px; }
    .tab-button { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 12px 20px; background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px var(--shadow-color); display: flex; align-items: center; gap: 6px; touch-action: manipulation; }
    .tab-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-color); }
    .tab-button.active { background-color: var(--accent-color); color: white; box-shadow: 0 4px 10px var(--shadow-color); transform: translateY(0); }
    .tab-content { background-color: var(--card-bg); border-radius: 20px; padding: 30px; box-shadow: 0 8px 20px var(--shadow-color); margin-bottom: 40px; min-height: 60vh; }
    .tab-panel { display: none; }
    .tab-panel.active { display: block; animation: fadeIn 0.4s ease-out forwards; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .section-title { font-size: 1.8rem; color: var(--text-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; }
    .section-description { font-size: 1rem; color: var(--text-color); opacity: 0.8; margin-bottom: 25px; max-width: 700px; }
    .asis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; }
    .card { background-color: var(--card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 4px 8px var(--shadow-color); transition: all 0.3s ease; border: 1px solid var(--border-color); height: 100%; display: flex; flex-direction: column; margin-bottom: 20px; /* Add margin for spacing in capture */ }
    .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px var(--shadow-color); }
    .tobe-card { background-color: var(--center-bg); border-color: var(--accent-color); }
    .card-title { font-size: 1.2rem; font-weight: 500; margin-bottom: 8px; color: var(--text-color); }
    .card-subtitle { font-size: 0.95rem; color: var(--text-color); opacity: 0.8; margin-bottom: 15px; }
    textarea { width: 100%; min-height: 150px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; font-family: 'Zen Maru Gothic', sans-serif; resize: vertical; color: #555; font-size: 0.95rem; transition: all 0.3s ease; flex-grow: 1; }
    textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--shadow-color); }
    .tab-navigation { display: flex; justify-content: space-between; margin-top: 30px; }
    .nav-button { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 10px 20px; background-color: var(--blue-accent); color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 8px rgba(125, 185, 238, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; touch-action: manipulation; }
    .nav-button:hover { background-color: #6baae0; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); }
    .nav-button.prev { background-color: #aaa; box-shadow: 0 4px 8px rgba(170, 170, 170, 0.3); }
    .nav-button.prev:hover { background-color: #888; box-shadow: 0 6px 12px rgba(136, 136, 136, 0.4); }
    .nav-button.invisible { visibility: hidden; }
    .progress-container { margin: 0 auto 30px; width: 100%; max-width: 800px; }
    .progress-bar { width: 100%; height: 8px; background-color: rgba(245, 170, 192, 0.2); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.5s ease; }
    .progress-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem; color: var(--text-color); opacity: 0.8; }
    .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; }
    .fab { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 10px 15px; color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.3s ease; width: auto; min-width: 120px; height: 40px; text-align: center; touch-action: manipulation; }
    .fab:hover { transform: translateY(-2px) scale(1.05); }
    .save-button-local { background-color: var(--accent-color); box-shadow: 0 4px 10px var(--shadow-color); }
    .save-button-local:hover { box-shadow: 0 6px 12px var(--shadow-color); }
    .download-button { background-color: var(--blue-accent); box-shadow: 0 4px 10px rgba(125, 185, 238, 0.3); }
    .download-button:hover { box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); }
    .upload-button { background-color: var(--green-accent); box-shadow: 0 4px 10px var(--green-shadow); }
    .upload-button:hover { box-shadow: 0 6px 12px var(--green-shadow); }
    #fileInput { display: none; }
    .notification { position: fixed; bottom: 150px; right: 20px; background-color: var(--accent-color); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; box-shadow: 0 4px 10px var(--shadow-color); transform: translateY(150px); opacity: 0; transition: transform 0.4s ease-out, opacity 0.4s ease-out; z-index: 99; pointer-events: none; }
    .notification.upload-success { background-color: var(--green-accent); color: #333; box-shadow: 0 4px 10px var(--green-shadow); }
    .notification.error { background-color: var(--error-color); box-shadow: 0 4px 10px rgba(238, 125, 125, 0.3); }
    .notification.show { transform: translateY(0); opacity: 1; }
    .check-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 2rem; margin-bottom: 1.5rem; }
    .check-actions button { padding: 10px 20px; color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
    .check-actions button:hover { transform: translateY(-2px); }
    #generate-image-btn { background-color: var(--blue-accent); box-shadow: 0 4px 8px rgba(125, 185, 238, 0.3); }
    #generate-image-btn:hover { background-color: #6baae0; box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); }
    #generate-image-btn:disabled { background-color: #aaa; cursor: not-allowed; transform: none; box-shadow: none; }
    #reviewButton { background-color: var(--green-accent); color: #333; box-shadow: 0 4px 8px var(--green-shadow); }
    #reviewButton:hover { background-color: #6bcdac; box-shadow: 0 6px 12px var(--green-shadow); }
    #review-summary-container { display: none; margin-top: 2rem; padding: 25px; background-color: var(--review-bg); border: 1px solid var(--review-border); border-radius: 15px; box-shadow: 0 4px 10px rgba(251, 220, 142, 0.2); color: #555; }
    .review-section { margin-bottom: 20px; } .review-section:last-child { margin-bottom: 0; }
    .review-section-title { font-size: 1.3rem; font-weight: 500; color: var(--text-color); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed var(--accent-color); display: flex; align-items: center; gap: 8px; }
    .review-content { font-size: 0.95rem; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; background-color: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(238, 125, 155, 0.1); }
    .review-content.asis-item { margin-bottom: 10px; border-left: 3px solid var(--accent-color); padding-left: 15px; }
    .review-content.asis-item strong { display: block; font-weight: 500; margin-bottom: 5px; color: var(--text-color); opacity: 0.9; }
    #review-image-container { display: none; text-align: center; margin-top: 1.5rem; background-color: #fff; padding: 20px; border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    #review-image { max-width: 100%; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 1rem; }
    #review-image-container p { font-size: 0.9rem; margin-top: 1rem; color: var(--text-color); opacity: 0.9; line-height: 1.5; }
    #tweet-btn { display: inline-block; margin-top: 1rem; padding: 10px 20px; background-color: #1DA1F2; color: white; border-radius: 30px; text-decoration: none; font-size: 1rem; font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(29, 161, 242, 0.3); }
    #tweet-btn:hover { background-color: #0c85d0; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(29, 161, 242, 0.4); }

    /* Styles for the temporary capture container */
    #capture-temp-container {
        /* Ensure it doesn't inherit unwanted styles */
        all: initial;
        /* Apply necessary base styles */
        font-family: 'Zen Maru Gothic', sans-serif;
        color: var(--text-color);
        line-height: 1.6;
        box-sizing: border-box; /* Apply box-sizing */

        /* Layout styles */
        position: absolute;
        left: -9999px; /* Position off-screen */
        top: 0;
        width: 800px; /* Fixed width for consistent image size */
        padding: 30px;
        background-color: var(--card-bg); /* Use tab content background */
        border-radius: 20px;
        box-shadow: 0 8px 20px var(--shadow-color);
        overflow: hidden; /* Prevent content overflow issues */
    }
    /* Apply styles for elements inside the temporary container */
    #capture-temp-container * {
         box-sizing: border-box; /* Ensure box-sizing is inherited */
    }
    #capture-temp-container .section-title,
    #capture-temp-container .section-description,
    #capture-temp-container .card,
    #capture-temp-container .card-title,
    #capture-temp-container .card-subtitle,
    #capture-temp-container .review-summary-container, /* Style the cloned review container if needed */
    #capture-temp-container .review-section,
    #capture-temp-container .review-section-title,
    #capture-temp-container .review-content,
    #capture-temp-container textarea /* Apply textarea styles for KPT card */
    {
        /* Re-apply specific styles needed for capture, potentially inheriting less */
        font-family: inherit; /* Inherit from container */
        color: inherit; /* Inherit from container (or set specific) */
        /* Add other necessary styles like margin, padding, borders */
    }
    /* Replicate card styles */
    #capture-temp-container .card {
      background-color: var(--card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 4px 8px var(--shadow-color); border: 1px solid var(--border-color); margin-bottom: 25px; /* Spacing */ display: flex; flex-direction: column;
    }
    #capture-temp-container .card-title { font-size: 1.2rem; font-weight: 500; margin-bottom: 8px; color: var(--text-color); }
    #capture-temp-container .card-subtitle { font-size: 0.95rem; color: var(--text-color); opacity: 0.8; margin-bottom: 15px; }
     #capture-temp-container textarea {
        width: 100%; min-height: 150px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; resize: none; color: #555; font-size: 0.95rem; flex-grow: 1; background-color: #fff; /* Ensure background */ overflow-wrap: break-word; white-space: pre-wrap;
     }
    /* Replicate review summary styles */
    #capture-temp-container .review-summary-container-clone {
         margin-top: 30px; padding: 25px; background-color: var(--review-bg); border: 1px solid var(--review-border); border-radius: 15px; box-shadow: 0 4px 10px rgba(251, 220, 142, 0.2); color: #555;
    }
     #capture-temp-container .review-section { margin-bottom: 20px; } #capture-temp-container .review-section:last-child { margin-bottom: 0; }
     #capture-temp-container .review-section-title { font-size: 1.3rem; font-weight: 500; color: var(--text-color); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed var(--accent-color); display: flex; align-items: center; gap: 8px; }
     #capture-temp-container .review-content { font-size: 0.95rem; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; background-color: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(238, 125, 155, 0.1); }
     #capture-temp-container .review-content.asis-item { margin-bottom: 10px; border-left: 3px solid var(--accent-color); padding-left: 15px; }
     #capture-temp-container .review-content.asis-item strong { display: block; font-weight: 500; margin-bottom: 5px; color: var(--text-color); opacity: 0.9; }


    /* Responsive Styles */
    @media (max-width: 768px) { /* ... (abbreviated) ... */
        body { padding: 15px; padding-bottom: 120px; } .header h1 { font-size: 1.8rem; } .header p { font-size: 1rem; } .asis-grid { grid-template-columns: 1fr; } .section-title { font-size: 1.5rem; } .tab-button { font-size: 0.9rem; padding: 10px 15px; } .tab-content { padding: 20px; } .fab-container { right: 15px; bottom: 15px; } .fab { font-size: 0.85rem; padding: 8px 12px; min-width: 100px; height: 36px; gap: 5px; } .notification { font-size: 0.85rem; padding: 10px 15px; right: 15px; bottom: 150px; } #generate-image-btn, #tweet-btn, .nav-button, #reviewButton { font-size: 0.9rem; padding: 8px 16px; } .check-actions { gap: 10px; } .review-section-title { font-size: 1.2rem; } .review-content { font-size: 0.9rem; }
        /* Adjust capture width for smaller screens if needed */
        #capture-temp-container { width: 90%; padding: 20px; }
    }
    @media (max-width: 480px) { /* ... (abbreviated) ... */
        .header h1 { font-size: 1.6rem; } .tab-button { font-size: 0.85rem; padding: 8px 12px; } .fab { font-size: 0.8rem; min-width: 40px; width: 40px; height: 40px; border-radius: 50%; padding: 0; } .fab span { display: none; } .notification { width: calc(100% - 30px); left: 15px; right: 15px; text-align: center; bottom: 170px; } .check-actions button span { /* display: none; */ }
    }
</style>
</head>
<body>
<div class="container">
    <div class="header">
        <h1>🌀 あるみ式のびしろサイクル</h1>
        <p>自己分析と行動設計のためのサイクル思考フレームワーク</p>
    </div>

    <div class="storage-note">
        <p>⚠️ ローカルストレージが使用できません。データ保存機能は限定的に動作します。</p>
        <p>※ブラウザを更新するとデータが消去されます。</p>
        <p>完全な機能を使う場合はウェブサーバー上でご利用ください。</p>
    </div>

    <div class="progress-container">
        <div class="progress-bar">
            <div class="progress-fill" id="progressBar"></div>
        </div>
        <div class="progress-labels">
            <span>サイクル進行状況</span>
            <span id="progressText">0%</span>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <div class="tabs-nav" id="tabsNav">
        <button class="tab-button active" data-tab="tobe">🌈 <span>TO-BE</span></button>
        <button class="tab-button" data-tab="asis">🔍 <span>AS-IS</span></button>
        <button class="tab-button" data-tab="rule">❌ <span>RULE</span></button>
        <button class="tab-button" data-tab="perk">🧰 <span>PERK</span></button>
        <button class="tab-button" data-tab="action">🛠 <span>ACTION</span></button>
        <button class="tab-button" data-tab="check">✅ <span>CHECK</span></button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- TO-BE Tab -->
        <div class="tab-panel active" id="tobe-panel">
            <h2 class="section-title">🌈 TO-BE（なりたい姿・理想の状態）</h2>
            <p class="section-description">ワクワクできる未来をイメージしましょう。あなたの目指したい状態・ありたい姿はどんなものですか？</p>
            <div class="card tobe-card">
                <h3 class="card-title">理想の状態を描く</h3>
                <p class="card-subtitle">目標ではなく、どんな風に生きていたいか、あり方を描いてみよう</p>
                <textarea data-section="tobe" id="tobe-input" placeholder="こんなふうに生きたい！どんな状態が理想？"></textarea>
            </div>
            <div class="tab-navigation">
                <button class="nav-button prev invisible">◀ <span>前へ</span></button>
                <button class="nav-button next" data-next="asis"><span>次へ</span> ▶</button>
            </div>
        </div>

        <!-- AS-IS Tab -->
        <div class="tab-panel" id="asis-panel">
            <h2 class="section-title">🔍 AS-IS（現状分析）</h2>
            <p class="section-description">現状を多角的に棚卸しましょう。自分自身や環境を客観的に見つめることで、次の一手が見えてきます。</p>
            <div class="asis-grid">
                <div class="card">
                    <h3 class="card-title">「理想とのギャップ」</h3>
                    <p class="card-subtitle">理想と比べて今の自分はどう？</p>
                    <textarea data-section="asis" id="asis-gap" placeholder="理想と比べて、どこで引っかかってる？"></textarea>
                </div>
                <div class="card">
                    <h3 class="card-title">「課題・つまずき」</h3>
                    <p class="card-subtitle">最近しんどいこと・止まっていることは？</p>
                    <textarea data-section="asis" id="asis-challenges" placeholder="どこでつまずいてる？何が難しい？"></textarea>
                </div>
                <div class="card">
                    <h3 class="card-title">「感情・不安・焦り」</h3>
                    <p class="card-subtitle">モヤモヤしてることは？</p>
                    <textarea data-section="asis" id="asis-emotions" placeholder="なんとなく不安なこと、ぼんやりでもOKです"></textarea>
                </div>
                <div class="card">
                    <h3 class="card-title">「外的な制約」</h3>
                    <p class="card-subtitle">自分では動かせない環境要因って？</p>
                    <textarea data-section="asis" id="asis-constraints" placeholder="周りの状況で変えられないことは？"></textarea>
                </div>
                <div class="card">
                    <h3 class="card-title">「過去の影響・トラウマ」</h3>
                    <p class="card-subtitle">昔の経験が今の行動に影響してる？</p>
                    <textarea data-section="asis" id="asis-past" placeholder="過去の経験で今も影響してることある？"></textarea>
                </div>
            </div>
            <div class="tab-navigation">
                <button class="nav-button prev" data-prev="tobe">◀ <span>前へ</span></button>
                <button class="nav-button next" data-next="rule"><span>次へ</span> ▶</button>
            </div>
        </div>

        <!-- RULE Tab -->
        <div class="tab-panel" id="rule-panel">
             <h2 class="section-title">❌ RULE（やらないこと・避けたい方向）</h2>
            <p class="section-description">自分を守るための境界線を設定しましょう。「もうこれはやらない」と決めることで、効率的に前に進めます。</p>
            <div class="card">
                <h3 class="card-title">自分を守る設計</h3>
                <p class="card-subtitle">無理しないための"やらない宣言"を書こう</p>
                <textarea data-section="rule" id="rule-input" placeholder="これはもうやらない、避けたいことを書いてみよう"></textarea>
            </div>
            <div class="tab-navigation">
                <button class="nav-button prev" data-prev="asis">◀ <span>前へ</span></button>
                <button class="nav-button next" data-next="perk"><span>次へ</span> ▶</button>
            </div>
        </div>

        <!-- PERK Tab -->
        <div class="tab-panel" id="perk-panel">
             <h2 class="section-title">🧰 PERK（使える装備）</h2>
            <p class="section-description">今の自分が持つ強みやリソースを見つめましょう。既に手に入れたスキルや経験、人脈も大切な装備です。</p>
            <div class="card">
                <h3 class="card-title">自分の装備を見つめる</h3>
                <p class="card-subtitle">今のスキル・経験・知識を棚卸しする</p>
                <textarea data-section="perk" id="perk-input" placeholder="今の自分にある武器って？使えるスキルは？"></textarea>
            </div>
            <div class="tab-navigation">
                <button class="nav-button prev" data-prev="rule">◀ <span>前へ</span></button>
                <button class="nav-button next" data-next="action"><span>次へ</span> ▶</button>
            </div>
        </div>

        <!-- ACTION Tab -->
        <div class="tab-panel" id="action-panel">
             <h2 class="section-title">🛠 ACTION（手段・行動）</h2>
            <p class="section-description">理想に近づくための具体的な一歩を設計しましょう。TO-BEに近づくために、今の自分にできることは何でしょう？</p>
            <div class="card">
                <h3 class="card-title">次の一手を考える</h3>
                <p class="card-subtitle">理想に近づくために今できることは？</p>
                <textarea data-section="action" id="action-input" placeholder="具体的に何をする？いつまでに？どうやって？"></textarea>
            </div>
            <div class="tab-navigation">
                <button class="nav-button prev" data-prev="perk">◀ <span>前へ</span></button>
                <button class="nav-button next" data-next="check"><span>次へ</span> ▶</button>
            </div>
        </div>

        <!-- CHECK Tab -->
        <div class="tab-panel" id="check-panel">
            <h2 class="section-title">✅ CHECK（振り返り）</h2>
            <p class="section-description">行動の結果を振り返り、次のサイクルにつなげましょう。うまくいったこと、改善点、次に試したいことを整理します。</p>
            <div class="card">
                <h3 class="card-title">KPTで振り返る</h3>
                <p class="card-subtitle">Keep／Problem／Tryで次のサイクルにつなげよう</p>
                <textarea data-section="check" id="check-input" placeholder="よかったこと(Keep)／改善点(Problem)／次にやってみること(Try)"></textarea>
            </div>

            <!-- Action Buttons Area -->
            <div class="check-actions">
                <button id="reviewButton">📝 <span>入力内容をレビュー</span></button>
                <button id="generate-image-btn">🖼️ <span>レビュー内容を画像化</span></button> <!-- Changed text -->
            </div>

            <!-- Review Summary Container -->
            <div id="review-summary-container">
                <!-- Review content will be injected here by JS -->
            </div>

            <!-- Image Generation Output -->
            <div id="review-image-container">
                <img alt="のびしろ記録レビュー" id="review-image" src=""/> <!-- Alt text changed -->
                 <p id="image-save-instruction">
                    <!-- Instruction text will be updated by JS -->
                 </p>
                <a href="#" id="tweet-btn" target="_blank" rel="noopener noreferrer">
                    ツイートする
                </a>
            </div>

            <!-- Tab Navigation -->
             <div class="tab-navigation" style="margin-top: 2rem;">
                <button class="nav-button prev" data-prev="action">◀ <span>前へ</span></button>
                <button class="nav-button next restart" data-next="tobe"><span>サイクル再始動</span> 🔄</button>
            </div>
        </div>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fab-container">
        <button class="fab save-button-local" id="saveButtonLocal">💾 <span>保存(ﾛｰｶﾙ)</span></button>
        <button class="fab download-button" id="downloadButton">💾 <span>DL(ﾌｧｲﾙ)</span></button>
        <button class="fab upload-button" id="uploadButton">📤 <span>UL(読込)</span></button>
    </div>
    <!-- Hidden File Input -->
    <input type="file" id="fileInput" accept=".json">

    <!-- Notifications -->
    <div class="notification" id="saveNotificationLocal">ローカルに保存しました！</div>
    <div class="notification upload-success" id="uploadNotificationSuccess">ファイルを読み込みました！</div>
    <div class="notification error" id="uploadNotificationError">ファイルの読み込みに失敗しました。</div>

</div>

<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Main Application Logic -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Element References ---
    const tabsNav = document.getElementById('tabsNav'); /* ... other refs */
    const tabButtons = tabsNav.querySelectorAll('.tab-button');
    const tabPanels = document.querySelectorAll('.tab-panel');
    const textareas = document.querySelectorAll('textarea');
    const saveButtonLocal = document.getElementById('saveButtonLocal');
    const downloadButton = document.getElementById('downloadButton');
    const uploadButton = document.getElementById('uploadButton');
    const fileInput = document.getElementById('fileInput');
    const saveNotificationLocal = document.getElementById('saveNotificationLocal');
    const uploadNotificationSuccess = document.getElementById('uploadNotificationSuccess');
    const uploadNotificationError = document.getElementById('uploadNotificationError');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');
    const storageNote = document.querySelector('.storage-note');
    const generateBtn = document.getElementById('generate-image-btn');
    const outputContainer = document.getElementById('review-image-container');
    const outputImg = document.getElementById('review-image');
    const tweetBtn = document.getElementById('tweet-btn');
    const reviewButton = document.getElementById('reviewButton');
    const reviewSummaryContainer = document.getElementById('review-summary-container');
    const imageSaveInstruction = document.getElementById('image-save-instruction');

    // --- State Variables ---
    const tabOrder = ['tobe', 'asis', 'rule', 'perk', 'action', 'check']; /* ... other vars */
    const reviewSections = {
        'tobe': { title: '🌈 TO-BE（なりたい姿・理想の状態）', ids: ['tobe-input'] },
        'asis': { title: '🔍 AS-IS（現状分析）', ids: ['asis-gap', 'asis-challenges', 'asis-emotions', 'asis-constraints', 'asis-past'] },
        'rule': { title: '❌ RULE（やらないこと・避けたい方向）', ids: ['rule-input'] },
        'perk': { title: '🧰 PERK（使える装備）', ids: ['perk-input'] },
        'action': { title: '🛠 ACTION（手段・行動）', ids: ['action-input'] },
    };
    let currentTabIndex = 0;
    let isLocalStorageAvailable = true;
    let notificationTimeout;

    // --- Helper Functions ---
    function getLocalStorageKey(textareaElement) { /* ... (same as before) ... */
        const section = textareaElement.dataset.section; const id = textareaElement.id; if (section && id) return `arumi_${section}_${id}`; console.warn('Missing data-section or id:', textareaElement); return null;
    }
    function showNotification(element, duration = 2000) { /* ... (same as before) ... */
        if (notificationTimeout) clearTimeout(notificationTimeout); [saveNotificationLocal, uploadNotificationSuccess, uploadNotificationError].forEach(el => el.classList.remove('show')); element.classList.add('show'); notificationTimeout = setTimeout(() => element.classList.remove('show'), duration);
    }

    // --- LocalStorage Functions ---
    function checkLocalStorage() { /* ... (same as before) ... */
        try { localStorage.setItem('__arumi_test__', '__test__'); localStorage.removeItem('__arumi_test__'); isLocalStorageAvailable = true; storageNote.style.display = 'none'; console.info('LocalStorage available.'); }
        catch (e) { isLocalStorageAvailable = false; storageNote.style.display = 'block'; console.warn('LocalStorage unavailable.'); if (saveButtonLocal) { saveButtonLocal.disabled = true; saveButtonLocal.style.opacity = 0.5; saveButtonLocal.style.cursor = 'not-allowed'; }}
    }
    function saveInputsToLocal() { /* ... (same as before) ... */
        if (!isLocalStorageAvailable) return false; let changed = false; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key) { const current = localStorage.getItem(key); if (current !== ta.value) { localStorage.setItem(key, ta.value); changed = true; } } }); if (changed) console.log('Inputs saved to localStorage.'); return changed;
    }
    function restoreInputsFromLocal() { /* ... (same as before) ... */
        if (!isLocalStorageAvailable) return; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key) { const saved = localStorage.getItem(key); if (saved !== null) ta.value = saved; } }); console.log('Inputs restored from localStorage.');
    }

    // --- File Download/Upload Functions ---
    function getAllInputsData() { /* ... (same as before) ... */
        const data = {}; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key) data[key] = ta.value; }); return data;
    }
    function downloadDataAsFile() { /* ... (same as before) ... */
        const data = getAllInputsData(); const jsonData = JSON.stringify(data, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-'); a.download = `nobishiro_cycle_data_${ts}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); console.log('Data downloaded.');
    }
    function restoreInputsFromFileData(data) { /* ... (same as before) ... */
        let count = 0; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key && data.hasOwnProperty(key)) { ta.value = data[key]; count++; } }); console.log(`Restored ${count} inputs from file.`); saveInputsToLocal();
    }
    function handleFileUpload(event) { /* ... (same as before) ... */
        const file = event.target.files[0]; if (!file) return; if (file.type !== 'application/json') { showNotification(uploadNotificationError, 3000); uploadNotificationError.textContent = 'JSONファイルを選択してください。'; fileInput.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); restoreInputsFromFileData(data); showNotification(uploadNotificationSuccess, 2000); uploadNotificationSuccess.textContent = 'ファイルを読み込みました！'; } catch (error) { console.error('File parse error:', error); showNotification(uploadNotificationError, 3000); uploadNotificationError.textContent = 'ファイルの形式が正しくありません。'; } finally { fileInput.value = ''; } }; reader.onerror = () => { console.error('File read error'); showNotification(uploadNotificationError, 3000); uploadNotificationError.textContent = 'ファイルの読み込み中にエラーが発生しました。'; fileInput.value = ''; }; reader.readAsText(file);
    }

    // --- UI Update Functions ---
    function updateProgress() { /* ... (same as before) ... */
        const progress = ((currentTabIndex + 1) / tabOrder.length) * 100; progressBar.style.width = `${progress}%`; progressText.textContent = `${Math.round(progress)}%`;
    }

    function showTab(tabId) { /* ... (modified) ... */
      const targetIndex = tabOrder.indexOf(tabId); if (targetIndex === -1) { console.error(`Tab ID "${tabId}" not found.`); return; } currentTabIndex = targetIndex;
      tabButtons.forEach((button, index) => button.classList.toggle('active', index === currentTabIndex));
      tabPanels.forEach((panel, index) => { const panelId = tabOrder[index]; if (panel.id === `${panelId}-panel`) panel.classList.toggle('active', index === currentTabIndex); });
      updateProgress(); outputContainer.style.display = "none"; outputImg.src = ""; reviewSummaryContainer.style.display = "none"; generateBtn.textContent = '🖼️ レビュー内容を画像化'; generateBtn.disabled = false;
    }

    // --- Review Summary Function ---
    function displayReviewSummary() { /* ... (modified for robustness) ... */
        saveInputsToLocal(); // Save current state before reviewing
        let summaryHTML = ''; let hasContent = false;

        for (const sectionKey in reviewSections) {
            if (!reviewSections.hasOwnProperty(sectionKey)) continue; // Ensure own properties

            const sectionInfo = reviewSections[sectionKey];
            let sectionContentHTML = '';
            let sectionHasContent = false;

            if (sectionKey === 'asis') {
                // Special handling for multiple AS-IS textareas
                sectionInfo.ids.forEach(id => {
                    const textarea = document.getElementById(id);
                    const card = textarea ? textarea.closest('.card') : null;
                    // Use card title as a fallback if subtitle is missing
                    const subtitle = card ? (card.querySelector('.card-subtitle')?.textContent || card.querySelector('.card-title')?.textContent || '') : '';
                    const value = textarea ? textarea.value.trim() : '';
                    if (value) { // Only show if there's content
                        sectionContentHTML += `<div class="review-content asis-item">`;
                        sectionContentHTML += `<strong>${subtitle.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong>`; // Add subtitle
                        sectionContentHTML += `${value.replace(/</g, "&lt;").replace(/>/g, "&gt;")}`; // Basic escaping
                        sectionContentHTML += `</div>`;
                        sectionHasContent = true;
                    }
                });
                 if (!sectionHasContent) {
                     sectionContentHTML += `<div class="review-content">（未入力）</div>`;
                 }

            } else {
                // Handling for single textarea sections
                const textarea = document.getElementById(sectionInfo.ids[0]);
                const value = textarea ? textarea.value.trim() : '';
                 sectionContentHTML += `<pre class="review-content">${value ? value.replace(/</g, "&lt;").replace(/>/g, "&gt;") : '（未入力）'}</pre>`;
                 if (value) sectionHasContent = true;
            }

            // Only add the section if it has content OR it's a mandatory section (e.g., TO-BE)
            // For simplicity, we'll show all sections for now, even if empty.
             summaryHTML += `<div class="review-section">`;
             summaryHTML += `<h4 class="review-section-title">${sectionInfo.title}</h4>`;
             summaryHTML += sectionContentHTML;
             summaryHTML += `</div>`;
             if (sectionHasContent) hasContent = true; // Mark that at least one section has content
        }

        reviewSummaryContainer.innerHTML = summaryHTML;
        reviewSummaryContainer.style.display = 'block';
        outputContainer.style.display = "none"; // Hide image if shown

        // Scroll to the review section
        reviewSummaryContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        console.log('Review summary displayed.');
    }


    // --- Event Listeners ---

    // Tab Button Clicks
    tabButtons.forEach(button => button.addEventListener('click', () => { const id = button.dataset.tab; if (id) showTab(id); }));

    // Navigation Button Clicks (Next/Prev)
    document.querySelectorAll('.nav-button').forEach(button => { /* ... (same as before) ... */
        button.addEventListener('click', () => { let nextTabId = null; const isNext = button.classList.contains('next'); const isPrev = button.classList.contains('prev'); const isRestart = button.classList.contains('restart'); if (isNext && !isRestart && currentTabIndex < tabOrder.length - 1) nextTabId = tabOrder[currentTabIndex + 1]; else if (isPrev && currentTabIndex > 0) nextTabId = tabOrder[currentTabIndex - 1]; else if (isRestart) nextTabId = tabOrder[0]; if (nextTabId) { showTab(nextTabId); const ct = document.querySelector('.container').offsetTop; window.scrollTo({ top: ct - 20, behavior: 'smooth' }); } });
    });

    // Local Save Button Click
    if (saveButtonLocal) saveButtonLocal.addEventListener('click', () => { if (isLocalStorageAvailable && saveInputsToLocal()) showNotification(saveNotificationLocal, 2000); });
    // Download Button Click
    if (downloadButton) downloadButton.addEventListener('click', downloadDataAsFile);
    // Upload Button Click -> Trigger File Input
    if (uploadButton && fileInput) uploadButton.addEventListener('click', () => fileInput.click());
    // File Input Change (File Selected)
    if (fileInput) fileInput.addEventListener('change', handleFileUpload);

    // Textarea Auto-save on Input (throttled)
    let debounceTimer; textareas.forEach(ta => ta.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveInputsToLocal, 500); }));

    // Review Button Click
    if (reviewButton) reviewButton.addEventListener('click', displayReviewSummary);

    // Generate Image Button Click (Captures specific elements)
    if (generateBtn) {
        generateBtn.addEventListener('click', () => {
            // 1. Check if review is displayed
            if (reviewSummaryContainer.style.display !== 'block') {
                alert('先に「入力内容をレビュー」ボタンを押して、レビュー内容を表示してください。');
                return;
            }

            saveInputsToLocal(); // Save current state

            generateBtn.textContent = '画像生成中...';
            generateBtn.disabled = true;

            // 2. Create temporary container
            const tempContainer = document.createElement('div');
            tempContainer.id = 'capture-temp-container';
            // Styles are applied via CSS using the ID

            // 3. Clone required elements and append to temp container
            const checkPanel = document.getElementById('check-panel');
            const title = checkPanel.querySelector('.section-title');
            const description = checkPanel.querySelector('.section-description');
            const kptCard = checkPanel.querySelector('.card'); // KPT card

            if (title) tempContainer.appendChild(title.cloneNode(true));
            if (description) tempContainer.appendChild(description.cloneNode(true));
            if (kptCard) {
                const clonedKptCard = kptCard.cloneNode(true);
                // Ensure textarea value is visible in the clone (important!)
                const originalTextarea = kptCard.querySelector('textarea');
                const clonedTextarea = clonedKptCard.querySelector('textarea');
                if (originalTextarea && clonedTextarea) {
                    clonedTextarea.value = originalTextarea.value; // Copy value explicitly
                    clonedTextarea.style.height = originalTextarea.scrollHeight + 'px'; // Try to set height
                }
                 tempContainer.appendChild(clonedKptCard);
            }

            // Clone the displayed review container
            const clonedReview = reviewSummaryContainer.cloneNode(true);
            clonedReview.style.display = 'block'; // Ensure it's visible
            clonedReview.id = ''; // Avoid duplicate IDs
            clonedReview.classList.add('review-summary-container-clone'); // Add class for styling in capture
            tempContainer.appendChild(clonedReview);

            // 4. Append temp container to body (off-screen)
            document.body.appendChild(tempContainer);

            // 5. html2canvas capture
             const options = {
                scale: window.devicePixelRatio || 1.5, // Higher resolution
                useCORS: true,
                backgroundColor: null, // Background set on the container CSS
                logging: false,
                scrollX: 0, // Reset scroll for the temp container
                scrollY: 0,
                windowWidth: tempContainer.scrollWidth, // Use container's width/height
                windowHeight: tempContainer.scrollHeight
             };

            setTimeout(() => { // Delay for rendering
                 html2canvas(tempContainer, options).then(canvas => {
                     const dataURL = canvas.toDataURL("image/png", 0.95);
                     outputImg.src = dataURL;
                     outputContainer.style.display = "block";

                     const tweetText = "あるみ式のびしろサイクルで振り返り＆レビュー！ #あるみ式のびしろサイクル";
                     tweetBtn.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;

                     if (imageSaveInstruction) {
                         imageSaveInstruction.innerHTML = `
                            （レビュー内容を含む画像）<br/>
                            📲 <strong>画像を長押しして保存</strong> して、<br/>
                            ツイートに添付して投稿してね！<br/>
                            💻 PC: <strong>右クリック → 名前をつけて画像を保存</strong>
                         `;
                     }

                     outputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     generateBtn.textContent = '🖼️ 画像を再生成';

                 }).catch(error => {
                     console.error('html2canvas failed:', error);
                     alert('画像の生成に失敗しました。\n内容が複雑すぎるか、ブラウザの制限に問題がある可能性があります。');
                     generateBtn.textContent = '🔄 画像生成再試行';
                 }).finally(() => {
                     // 6. Remove temp container
                     document.body.removeChild(tempContainer);
                     generateBtn.disabled = false;
                 });
            }, 150); // Adjust delay if needed

        });
    } else { console.error('Generate image button not found.'); }


    // --- Initial Setup ---
    checkLocalStorage();
    restoreInputsFromLocal();
    showTab(tabOrder[0]);

  });
</script>

</body>
</html>
