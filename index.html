<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" name="viewport"/>
<title>あるみ式のびしろサイクル</title>
<link href="https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@300;400;500;700&amp;display=swap" rel="stylesheet"/>
<style>
    :root { /* Color variables (unchanged) */
      --bg-color: #fff6f9; --card-bg: #ffffff; --center-bg: #fffcef; --accent-color: #f5aac0; --text-color: #ee7d9b; --shadow-color: rgba(245, 170, 192, 0.3); --border-color: rgba(238, 125, 155, 0.2); --blue-accent: #7db9ee; --green-accent: #7deebb; --green-shadow: rgba(125, 238, 187, 0.3); --review-bg: #fef9e7; --review-border: #fbdc8e; --error-color: #ee7d7d; --error-shadow: rgba(238, 125, 125, 0.3); --info-color: #7db9ee; --info-shadow: rgba(125, 185, 238, 0.3); --placeholder-color: #999; --textarea-text-color: #555;
    }
    /* --- Base Styles (unchanged) --- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Zen Maru Gothic', sans-serif; background-color: var(--bg-color); color: var(--text-color); line-height: 1.6; padding: 20px; padding-bottom: 140px; scroll-behavior: smooth; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; }
    /* --- Other general styles (unchanged) --- */
    .header { text-align: center; margin-bottom: 30px; } .header h1 { font-size: 2.2rem; color: var(--text-color); margin-bottom: 10px; } .header p { font-size: 1.1rem; color: var(--text-color); opacity: 0.8; max-width: 600px; margin: 0 auto; }
    .storage-note { background-color: rgba(245, 170, 192, 0.1); border: 1px solid var(--border-color); border-radius: 8px; padding: 15px; margin: 20px auto; max-width: 800px; font-size: 0.9rem; color: var(--text-color); text-align: center; display: none; } .storage-note p { margin: 5px 0; }
    .progress-container { margin: 0 auto 30px; width: 100%; max-width: 800px; } .progress-bar { width: 100%; height: 8px; background-color: rgba(245, 170, 192, 0.2); border-radius: 4px; overflow: hidden; } .progress-fill { height: 100%; background-color: var(--accent-color); width: 0%; transition: width 0.5s ease; } .progress-labels { display: flex; justify-content: space-between; margin-top: 10px; font-size: 0.8rem; color: var(--text-color); opacity: 0.8; }
    .tabs-nav { display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; margin-bottom: 30px; } .tab-button { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 12px 20px; background-color: var(--card-bg); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 2px 5px var(--shadow-color); display: flex; align-items: center; gap: 6px; touch-action: manipulation; } .tab-button:hover { transform: translateY(-2px); box-shadow: 0 4px 8px var(--shadow-color); } .tab-button.active { background-color: var(--accent-color); color: white; box-shadow: 0 4px 10px var(--shadow-color); transform: translateY(0); }
    .tab-content { background-color: var(--card-bg); border-radius: 20px; padding: 30px; box-shadow: 0 8px 20px var(--shadow-color); margin-bottom: 40px; min-height: 60vh; } .tab-panel { display: none; } .tab-panel.active { display: block; animation: fadeIn 0.4s ease-out forwards; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .section-title { font-size: 1.8rem; color: var(--text-color); margin-bottom: 15px; display: flex; align-items: center; gap: 10px; } .section-description { font-size: 1rem; color: var(--text-color); opacity: 0.8; margin-bottom: 25px; max-width: 700px; }
    .asis-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; } .card { background-color: var(--card-bg); border-radius: 15px; padding: 20px; box-shadow: 0 4px 8px var(--shadow-color); transition: all 0.3s ease; border: 1px solid var(--border-color); height: 100%; display: flex; flex-direction: column; margin-bottom: 20px; } .card:hover { transform: translateY(-5px); box-shadow: 0 8px 15px var(--shadow-color); } .tobe-card { background-color: var(--center-bg); border-color: var(--accent-color); } .card-title { font-size: 1.2rem; font-weight: 500; margin-bottom: 8px; color: var(--text-color); } .card-subtitle { font-size: 0.95rem; color: var(--text-color); opacity: 0.8; margin-bottom: 15px; } textarea { width: 100%; min-height: 150px; border: 1px solid var(--border-color); border-radius: 8px; padding: 10px; font-family: 'Zen Maru Gothic', sans-serif; resize: vertical; color: var(--textarea-text-color); font-size: 0.95rem; transition: all 0.3s ease; flex-grow: 1; background-color: #fff; } textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px var(--shadow-color); }
    .tab-navigation { display: flex; justify-content: space-between; margin-top: 30px; } .nav-button { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 10px 20px; background-color: var(--blue-accent); color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; box-shadow: 0 4px 8px rgba(125, 185, 238, 0.3); transition: all 0.3s ease; display: flex; align-items: center; gap: 8px; touch-action: manipulation; } .nav-button:hover { background-color: #6baae0; transform: translateY(-2px); box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); } .nav-button.prev { background-color: #aaa; box-shadow: 0 4px 8px rgba(170, 170, 170, 0.3); } .nav-button.prev:hover { background-color: #888; box-shadow: 0 6px 12px rgba(136, 136, 136, 0.4); } .nav-button.invisible { visibility: hidden; }
    .fab-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 10px; z-index: 100; } .fab { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 10px 15px; color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; gap: 8px; cursor: pointer; transition: all 0.3s ease; width: auto; min-width: 120px; height: 40px; text-align: center; touch-action: manipulation; } .fab:hover { transform: translateY(-2px) scale(1.05); } .save-button-local { background-color: var(--accent-color); box-shadow: 0 4px 10px var(--shadow-color); } .save-button-local:hover { box-shadow: 0 6px 12px var(--shadow-color); } .download-button { background-color: var(--blue-accent); box-shadow: 0 4px 10px rgba(125, 185, 238, 0.3); } .download-button:hover { box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); } .upload-button { background-color: var(--green-accent); box-shadow: 0 4px 10px var(--green-shadow); } .upload-button:hover { box-shadow: 0 6px 12px var(--green-shadow); } .clear-button { background-color: var(--error-color); box-shadow: 0 4px 10px var(--error-shadow); } .clear-button:hover { background-color: #d96a6a; box-shadow: 0 6px 12px var(--error-shadow); } #fileInput { display: none; }
    .notification { position: fixed; bottom: 190px; right: 20px; background-color: var(--accent-color); color: white; padding: 12px 20px; border-radius: 8px; font-size: 0.9rem; box-shadow: 0 4px 10px var(--shadow-color); transform: translateY(190px); opacity: 0; transition: transform 0.4s ease-out, opacity 0.4s ease-out; z-index: 99; pointer-events: none; } .notification.upload-success { background-color: var(--green-accent); color: #333; box-shadow: 0 4px 10px var(--green-shadow); } .notification.error { background-color: var(--error-color); box-shadow: 0 4px 10px var(--error-shadow); } .notification.info { background-color: var(--info-color); box-shadow: 0 4px 10px var(--info-shadow); } .notification.show { transform: translateY(0); opacity: 1; }
    /* --- Check Actions (Review Button Only) --- */
    .check-actions { display: flex; flex-wrap: wrap; justify-content: center; gap: 15px; margin-top: 2rem; margin-bottom: 1.5rem; }
    .check-actions button { padding: 10px 20px; color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; }
    .check-actions button:hover { transform: translateY(-2px); }
    #reviewButton { background-color: var(--green-accent); color: #333; box-shadow: 0 4px 8px var(--green-shadow); }
    #reviewButton:hover { background-color: #6bcdac; box-shadow: 0 6px 12px var(--green-shadow); }
    /* --- Review Summary --- */
    #review-summary-container { display: none; margin-top: 2rem; padding: 25px; background-color: var(--review-bg); border: 1px solid var(--review-border); border-radius: 15px; box-shadow: 0 4px 10px rgba(251, 220, 142, 0.2); color: var(--textarea-text-color); } .review-section { margin-bottom: 20px; } .review-section:last-child { margin-bottom: 0; } .review-section-title { font-size: 1.3rem; font-weight: 500; color: var(--text-color); margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px dashed var(--accent-color); display: flex; align-items: center; gap: 8px; } .review-content { font-size: 0.95rem; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; background-color: rgba(255, 255, 255, 0.5); padding: 10px; border-radius: 8px; border: 1px solid rgba(238, 125, 155, 0.1); } .review-content.asis-item { margin-bottom: 10px; border-left: 3px solid var(--accent-color); padding-left: 15px; } .review-content.asis-item strong { display: block; font-weight: 500; margin-bottom: 5px; color: var(--text-color); opacity: 0.9; } .review-content.placeholder-text { color: var(--placeholder-color); font-style: italic; }
    /* --- Generate Image Button Wrapper --- */
    #generate-image-btn-wrapper { display: none; text-align: center; margin-top: 1.5rem; margin-bottom: 1.5rem; }
    #generate-image-btn { -webkit-appearance: none; -moz-appearance: none; appearance: none; padding: 10px 20px; color: white; border: none; border-radius: 30px; font-family: 'Zen Maru Gothic', sans-serif; font-size: 1rem; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 8px; touch-action: manipulation; background-color: var(--blue-accent); box-shadow: 0 4px 8px rgba(125, 185, 238, 0.3); }
    #generate-image-btn:hover { background-color: #6baae0; box-shadow: 0 6px 12px rgba(125, 185, 238, 0.4); transform: translateY(-2px); }
    #generate-image-btn:disabled { background-color: #aaa; cursor: not-allowed; transform: none; box-shadow: none; color: #eee; }
    /* --- Image Output --- */
    #review-image-container {
        display: none;
        text-align: center;
        margin-top: 1.5rem;
        background-color: #fff;
        padding: 20px;
        border-radius: 15px;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        /* === 画像表示エリアの幅を制限し中央揃え === */
        max-width: 600px; /* この値を調整してお好みのサイズに */
        margin-left: auto;
        margin-right: auto;
        /* ==================================== */
    }
    #review-image {
        max-width: 100%; /* コンテナに合わせて縮小 */
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 1rem;
        vertical-align: middle; /* 画像下の隙間対策 */
    }
    #review-image-container p { font-size: 0.9rem; margin-top: 1rem; color: var(--text-color); opacity: 0.9; line-height: 1.5; }
    /* Container for only the Tweet button */
    .output-actions { text-align: center; margin-top: 1.5rem; }
    #tweet-btn { display: inline-block; margin: 0; padding: 10px 20px; background-color: #1DA1F2; color: white; border-radius: 30px; text-decoration: none; font-size: 1rem; font-family: 'Zen Maru Gothic', sans-serif; transition: all 0.3s ease; box-shadow: 0 4px 8px rgba(29, 161, 242, 0.3); }
    #tweet-btn:hover { background-color: #0c85d0; box-shadow: 0 6px 12px rgba(29, 161, 242, 0.4); transform: translateY(-2px); }
    /* --- Styles for #capture-temp-container (Review Summary Only) --- */
    #capture-temp-container { all: initial; font-family: 'Zen Maru Gothic', sans-serif !important; line-height: 1.6 !important; box-sizing: border-box !important; position: absolute !important; left: -9999px !important; top: 0 !important; width: 800px !important; padding: 25px !important; background-color: #fef9e7 !important; border: 1px solid #fbdc8e !important; border-radius: 15px !important; box-shadow: 0 4px 10px rgba(251, 220, 142, 0.2) !important; overflow: hidden !important; color: #555 !important; }
    #capture-temp-container * { box-sizing: border-box !important; font-family: inherit !important; line-height: inherit !important; color: inherit !important; background-color: transparent !important; }
    #capture-temp-container .review-section { margin-bottom: 20px !important; } #capture-temp-container .review-section:last-child { margin-bottom: 0 !important; }
    #capture-temp-container .review-section-title { font-size: 1.3rem !important; font-weight: 500 !important; color: #ee7d9b !important; margin-bottom: 10px !important; padding-bottom: 5px !important; border-bottom: 1px dashed #f5aac0 !important; display: flex !important; align-items: center !important; gap: 8px !important; }
    #capture-temp-container .review-content { font-size: 0.95rem !important; line-height: 1.7 !important; white-space: pre-wrap !important; word-wrap: break-word !important; background-color: rgba(255, 255, 255, 0.5) !important; padding: 10px !important; border-radius: 8px !important; border: 1px solid rgba(238, 125, 155, 0.1) !important; color: #555 !important; }
    #capture-temp-container .review-content pre { font-family: inherit !important; margin: 0 !important; white-space: pre-wrap !important; word-wrap: break-word !important; color: inherit !important; background-color: transparent !important; }
    #capture-temp-container .review-content.asis-item { margin-bottom: 10px !important; border-left: 3px solid #f5aac0 !important; padding-left: 15px !important; }
    #capture-temp-container .review-content.asis-item strong { display: block !important; font-weight: 500 !important; margin-bottom: 5px !important; color: #ee7d9b !important; opacity: 0.9 !important; }
    #capture-temp-container .review-content.placeholder-text { color: #999 !important; font-style: italic !important; }

    /* --- Responsive Styles --- */
    @media (max-width: 768px) { body { padding: 15px; padding-bottom: 160px; } /* ... other responsive styles ... */ #capture-temp-container { width: 90% !important; padding: 20px !important; } #capture-temp-container .review-section-title { font-size: 1.2rem !important; } #capture-temp-container .review-content { font-size: 0.9rem !important; } #review-image-container { max-width: 90%; } /* Allow image container to shrink */ }
    @media (max-width: 480px) { body { padding-bottom: 200px; } /* ... other responsive styles ... */ .fab span { display: none; } .fab { min-width: 40px; width: 40px; height: 40px; border-radius: 50%; padding: 0; } .notification { width: calc(100% - 30px); left: 15px; right: 15px; text-align: center; bottom: 210px; } }
</style>
</head>
<body>
<div class="container">
    <!-- Header, Storage Note, Progress Bar, Tabs Navigation (unchanged) -->
    <div class="header"> <h1>🌀 あるみ式のびしろサイクル</h1> <p>自己分析と行動設計のためのサイクル思考フレームワーク</p> </div>
    <div class="storage-note"> <p>⚠️ ローカルストレージが使用できません。データ保存機能は限定的に動作します。</p> <p>※ブラウザを更新するとデータが消去されます。</p> <p>完全な機能を使う場合はウェブサーバー上でご利用ください。</p> </div>
    <div class="progress-container"> <div class="progress-bar"><div class="progress-fill" id="progressBar"></div></div> <div class="progress-labels"><span>サイクル進行状況</span><span id="progressText">0%</span></div> </div>
    <div class="tabs-nav" id="tabsNav"> <button class="tab-button active" data-tab="tobe">🌈 <span>TO-BE</span></button> <button class="tab-button" data-tab="asis">🔍 <span>AS-IS</span></button> <button class="tab-button" data-tab="rule">❌ <span>RULE</span></button> <button class="tab-button" data-tab="perk">🧰 <span>PERK</span></button> <button class="tab-button" data-tab="action">🛠 <span>ACTION</span></button> <button class="tab-button" data-tab="check">✅ <span>CHECK</span></button> </div>
    <!-- Tab Content -->
    <div class="tab-content">
        <!-- TO-BE, AS-IS, RULE, PERK, ACTION Tabs (unchanged) -->
        <div class="tab-panel active" id="tobe-panel"> <h2 class="section-title">🌈 TO-BE（なりたい姿・理想の状態）</h2> <p class="section-description">ワクワクできる未来をイメージしましょう。あなたの目指したい状態・ありたい姿はどんなものですか？</p> <div class="card tobe-card"> <h3 class="card-title">理想の状態を描く</h3> <p class="card-subtitle">目標ではなく、どんな風に生きていたいか、あり方を描いてみよう</p> <textarea data-section="tobe" id="tobe-input" placeholder="こんなふうに生きたい！どんな状態が理想？"></textarea> </div> <div class="tab-navigation"> <button class="nav-button prev invisible">◀ <span>前へ</span></button> <button class="nav-button next" data-next="asis"><span>次へ</span> ▶</button> </div> </div>
        <div class="tab-panel" id="asis-panel"> <h2 class="section-title">🔍 AS-IS（現状分析）</h2> <p class="section-description">現状を多角的に棚卸しましょう。自分自身や環境を客観的に見つめることで、次の一手が見えてきます。</p> <div class="asis-grid"> <div class="card"> <h3 class="card-title">「理想とのギャップ」</h3> <p class="card-subtitle">理想と比べて今の自分はどう？</p> <textarea data-section="asis" id="asis-gap" placeholder="理想と比べて、どこで引っかかってる？"></textarea> </div> <div class="card"> <h3 class="card-title">「課題・つまずき」</h3> <p class="card-subtitle">最近しんどいこと・止まっていることは？</p> <textarea data-section="asis" id="asis-challenges" placeholder="どこでつまずいてる？何が難しい？"></textarea> </div> <div class="card"> <h3 class="card-title">「感情・不安・焦り」</h3> <p class="card-subtitle">モヤモヤしてることは？</p> <textarea data-section="asis" id="asis-emotions" placeholder="なんとなく不安なこと、ぼんやりでもOKです"></textarea> </div> <div class="card"> <h3 class="card-title">「外的な制約」</h3> <p class="card-subtitle">自分では動かせない環境要因って？</p> <textarea data-section="asis" id="asis-constraints" placeholder="周りの状況で変えられないことは？"></textarea> </div> <div class="card"> <h3 class="card-title">「過去の影響・トラウマ」</h3> <p class="card-subtitle">昔の経験が今の行動に影響してる？</p> <textarea data-section="asis" id="asis-past" placeholder="過去の経験で今も影響してることある？"></textarea> </div> </div> <div class="tab-navigation"> <button class="nav-button prev" data-prev="tobe">◀ <span>前へ</span></button> <button class="nav-button next" data-next="rule"><span>次へ</span> ▶</button> </div> </div>
        <div class="tab-panel" id="rule-panel"> <h2 class="section-title">❌ RULE（やらないこと・避けたい方向）</h2> <p class="section-description">自分を守るための境界線を設定しましょう。「もうこれはやらない」と決めることで、効率的に前に進めます。</p> <div class="card"> <h3 class="card-title">自分を守る設計</h3> <p class="card-subtitle">無理しないための"やらない宣言"を書こう</p> <textarea data-section="rule" id="rule-input" placeholder="これはもうやらない、避けたいことを書いてみよう"></textarea> </div> <div class="tab-navigation"> <button class="nav-button prev" data-prev="asis">◀ <span>前へ</span></button> <button class="nav-button next" data-next="perk"><span>次へ</span> ▶</button> </div> </div>
        <div class="tab-panel" id="perk-panel"> <h2 class="section-title">🧰 PERK（使える装備）</h2> <p class="section-description">今の自分が持つ強みやリソースを見つめましょう。既に手に入れたスキルや経験、人脈も大切な装備です。</p> <div class="card"> <h3 class="card-title">自分の装備を見つめる</h3> <p class="card-subtitle">今のスキル・経験・知識を棚卸しする</p> <textarea data-section="perk" id="perk-input" placeholder="今の自分にある武器って？使えるスキルは？"></textarea> </div> <div class="tab-navigation"> <button class="nav-button prev" data-prev="rule">◀ <span>前へ</span></button> <button class="nav-button next" data-next="action"><span>次へ</span> ▶</button> </div> </div>
        <div class="tab-panel" id="action-panel"> <h2 class="section-title">🛠 ACTION（手段・行動）</h2> <p class="section-description">理想に近づくための具体的な一歩を設計しましょう。TO-BEに近づくために、今の自分にできることは何でしょう？</p> <div class="card"> <h3 class="card-title">次の一手を考える</h3> <p class="card-subtitle">理想に近づくために今できることは？</p> <textarea data-section="action" id="action-input" placeholder="具体的に何をする？いつまでに？どうやって？"></textarea> </div> <div class="tab-navigation"> <button class="nav-button prev" data-prev="perk">◀ <span>前へ</span></button> <button class="nav-button next" data-next="check"><span>次へ</span> ▶</button> </div> </div>
        <!-- CHECK Tab -->
        <div class="tab-panel" id="check-panel">
            <h2 class="section-title">✅ CHECK（振り返り）</h2>
            <p class="section-description">行動の結果を振り返り、次のサイクルにつなげましょう。うまくいったこと、改善点、次に試したいことを整理します。</p>
            <div class="card">
                <h3 class="card-title">KPTで振り返る</h3>
                <p class="card-subtitle">Keep／Problem／Tryで次のサイクルにつなげよう</p>
                <textarea data-section="check" id="check-input" placeholder="よかったこと(Keep)／改善点(Problem)／次にやってみること(Try)"></textarea>
            </div>
            <!-- Action Buttons Area (Review Button Only) -->
            <div class="check-actions">
                <button id="reviewButton">📝 <span>入力内容をレビュー</span></button>
            </div>
            <!-- Review Summary Container -->
            <div id="review-summary-container"></div>
            <!-- Generate Image Button Wrapper (Initially hidden) -->
            <div id="generate-image-btn-wrapper">
                 <button id="generate-image-btn">🖼️ <span>レビュー内容を画像化/コピー</span></button>
            </div>
            <!-- Image Generation Output -->
            <div id="review-image-container">
                <img alt="のびしろ記録レビュー" id="review-image" src=""/>
                <p id="image-save-instruction"></p>
                <!-- Container for only the Tweet button -->
                <div class="output-actions">
                     <a href="#" id="tweet-btn" target="_blank" rel="noopener noreferrer">ツイートする</a>
                </div>
            </div>
            <!-- Tab Navigation -->
            <div class="tab-navigation" style="margin-top: 2rem;">
                <button class="nav-button prev" data-prev="action">◀ <span>前へ</span></button>
                <button class="nav-button next restart" data-next="tobe"><span>サイクル再始動</span> 🔄</button>
            </div>
        </div>
    </div> <!-- End Tab Content -->

    <!-- FABs, File Input, Notifications (unchanged) -->
    <div class="fab-container"> <button class="fab save-button-local" id="saveButtonLocal" title="現在の入力内容をブラウザに保存します">💾 <span>保存(ﾛｰｶﾙ)</span></button> <button class="fab download-button" id="downloadButton" title="現在の入力内容をファイルに保存します">💾 <span>DL(ﾌｧｲﾙ)</span></button> <button class="fab upload-button" id="uploadButton" title="ファイルから入力内容を読み込みます">📤 <span>UL(読込)</span></button> <button class="fab clear-button" id="clearButtonLocal" title="ブラウザに保存された内容と現在の入力を全て消去します">🗑️ <span>全消去</span></button> </div>
    <input type="file" id="fileInput" accept=".json">
    <div class="notification" id="saveNotificationLocal">ローカルに保存しました！</div> <div class="notification upload-success" id="uploadNotificationSuccess">ファイルを読み込みました！</div> <div class="notification error" id="uploadNotificationError">ファイルの読み込みに失敗しました。</div> <div class="notification info" id="clearNotification">入力内容をリセットしました。</div>

</div> <!-- End Container -->

<!-- External Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<!-- Main Application Logic (unchanged from ver6.6) -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- Element References ---
    const tabsNav = document.getElementById('tabsNav'); const tabButtons = tabsNav.querySelectorAll('.tab-button'); const tabPanels = document.querySelectorAll('.tab-panel'); const textareas = document.querySelectorAll('textarea'); const saveButtonLocal = document.getElementById('saveButtonLocal'); const downloadButton = document.getElementById('downloadButton'); const uploadButton = document.getElementById('uploadButton'); const clearButtonLocal = document.getElementById('clearButtonLocal'); const fileInput = document.getElementById('fileInput'); const saveNotificationLocal = document.getElementById('saveNotificationLocal'); const uploadNotificationSuccess = document.getElementById('uploadNotificationSuccess'); const uploadNotificationError = document.getElementById('uploadNotificationError'); const clearNotification = document.getElementById('clearNotification'); const progressBar = document.getElementById('progressBar'); const progressText = document.getElementById('progressText'); const storageNote = document.querySelector('.storage-note');
    const generateBtn = document.getElementById('generate-image-btn');
    const generateBtnWrapper = document.getElementById('generate-image-btn-wrapper'); // Added reference
    const outputContainer = document.getElementById('review-image-container'); const outputImg = document.getElementById('review-image'); const tweetBtn = document.getElementById('tweet-btn'); const reviewButton = document.getElementById('reviewButton'); const reviewSummaryContainer = document.getElementById('review-summary-container'); const imageSaveInstruction = document.getElementById('image-save-instruction');
    // --- State Variables ---
    const tabOrder = ['tobe', 'asis', 'rule', 'perk', 'action', 'check']; const reviewSections = { 'tobe': { title: '🌈 TO-BE（なりたい姿・理想の状態）', ids: ['tobe-input'] }, 'asis': { title: '🔍 AS-IS（現状分析）', ids: ['asis-gap', 'asis-challenges', 'asis-emotions', 'asis-constraints', 'asis-past'] }, 'rule': { title: '❌ RULE（やらないこと・避けたい方向）', ids: ['rule-input'] }, 'perk': { title: '🧰 PERK（使える装備）', ids: ['perk-input'] }, 'action': { title: '🛠 ACTION（手段・行動）', ids: ['action-input'] }, }; const storagePrefix = 'arumi_'; let currentTabIndex = 0; let isLocalStorageAvailable = true; let notificationTimeout;
    // --- Helper Functions ---
    function getLocalStorageKey(textareaElement) { const section = textareaElement.dataset.section; const id = textareaElement.id; if (section && id) return `${storagePrefix}${section}_${id}`; console.warn('Missing data-section or id:', textareaElement); return null; }
    function showNotification(element, duration = 2000) { if (notificationTimeout) clearTimeout(notificationTimeout); [saveNotificationLocal, uploadNotificationSuccess, uploadNotificationError, clearNotification].forEach(el => { if (el) el.classList.remove('show'); }); if (element) { element.classList.add('show'); notificationTimeout = setTimeout(() => element.classList.remove('show'), duration); } }
    // --- LocalStorage Functions ---
    function checkLocalStorage() { try { localStorage.setItem('__arumi_test__', '__test__'); localStorage.removeItem('__arumi_test__'); isLocalStorageAvailable = true; storageNote.style.display = 'none'; console.info('LocalStorage available.'); } catch (e) { isLocalStorageAvailable = false; storageNote.style.display = 'block'; console.warn('LocalStorage unavailable.'); if (saveButtonLocal) { saveButtonLocal.disabled = true; saveButtonLocal.style.opacity = 0.5; saveButtonLocal.style.cursor = 'not-allowed'; } if (clearButtonLocal) { clearButtonLocal.disabled = true; clearButtonLocal.style.opacity = 0.5; clearButtonLocal.style.cursor = 'not-allowed'; } } }
    function saveInputsToLocal() { if (!isLocalStorageAvailable) return false; let changed = false; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key) { const current = localStorage.getItem(key); if (current !== ta.value) { localStorage.setItem(key, ta.value); changed = true; } } }); if (changed) console.log('Inputs saved to localStorage.'); return changed; }
    function restoreInputsFromLocal() { if (!isLocalStorageAvailable) return; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key) { const saved = localStorage.getItem(key); if (saved !== null) ta.value = saved; } }); console.log('Inputs restored from localStorage.'); }
    function clearAllInputs() { if (!isLocalStorageAvailable) { textareas.forEach(ta => ta.value = ''); console.log('Textareas cleared (localStorage unavailable).'); return; } let keysToRemove = []; for (let i = 0; i < localStorage.length; i++) { const key = localStorage.key(i); if (key && key.startsWith(storagePrefix)) { keysToRemove.push(key); } } keysToRemove.forEach(key => localStorage.removeItem(key)); console.log('LocalStorage data cleared.'); textareas.forEach(ta => ta.value = ''); console.log('Textareas cleared.'); }
    // --- File Download/Upload Functions ---
    function getAllInputsData() { const data = {}; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key) data[key] = ta.value; }); return data; }
    function downloadDataAsFile() { const data = getAllInputsData(); const jsonData = JSON.stringify(data, null, 2); const blob = new Blob([jsonData], { type: 'application/json' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; const ts = new Date().toISOString().slice(0, 19).replace(/[:T]/g, '-'); a.download = `nobishiro_cycle_data_${ts}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url); console.log('Data downloaded.'); }
    function restoreInputsFromFileData(data) { let count = 0; textareas.forEach(ta => { const key = getLocalStorageKey(ta); if (key && data.hasOwnProperty(key)) { ta.value = data[key]; count++; } }); console.log(`Restored ${count} inputs from file.`); saveInputsToLocal(); }
    function handleFileUpload(event) { const file = event.target.files[0]; if (!file) return; if (file.type !== 'application/json') { showNotification(uploadNotificationError, 3000); uploadNotificationError.textContent = 'JSONファイルを選択してください。'; fileInput.value = ''; return; } const reader = new FileReader(); reader.onload = (e) => { try { const data = JSON.parse(e.target.result); restoreInputsFromFileData(data); showNotification(uploadNotificationSuccess, 2000); uploadNotificationSuccess.textContent = 'ファイルを読み込みました！'; } catch (error) { console.error('File parse error:', error); showNotification(uploadNotificationError, 3000); uploadNotificationError.textContent = 'ファイルの形式が正しくありません。'; } finally { fileInput.value = ''; } }; reader.onerror = () => { console.error('File read error'); showNotification(uploadNotificationError, 3000); uploadNotificationError.textContent = 'ファイルの読み込み中にエラーが発生しました。'; fileInput.value = ''; }; reader.readAsText(file); }
    // --- UI Update Functions ---
    function updateProgress() { const progress = ((currentTabIndex + 1) / tabOrder.length) * 100; progressBar.style.width = `${progress}%`; progressText.textContent = `${Math.round(progress)}%`; }
    function showTab(tabId) { const targetIndex = tabOrder.indexOf(tabId); if (targetIndex === -1) { console.error(`Tab ID "${tabId}" not found.`); return; } currentTabIndex = targetIndex; tabButtons.forEach((button, index) => button.classList.toggle('active', index === currentTabIndex)); tabPanels.forEach((panel, index) => { const panelId = tabOrder[index]; if (panel.id === `${panelId}-panel`) panel.classList.toggle('active', index === currentTabIndex); }); updateProgress();
      outputContainer.style.display = "none"; outputImg.src = ""; reviewSummaryContainer.style.display = "none";
      if(generateBtnWrapper) generateBtnWrapper.style.display = 'none'; // Hide wrapper too
      generateBtn.textContent = '🖼️ レビュー内容を画像化/コピー'; generateBtn.disabled = false;
    }
    // --- Review Summary Function ---
    function displayReviewSummary() {
        saveInputsToLocal(); let summaryHTML = '';
        for (const sectionKey in reviewSections) { if (!reviewSections.hasOwnProperty(sectionKey)) continue; const sectionInfo = reviewSections[sectionKey]; let sectionContentHTML = ''; let sectionHasContent = false; if (sectionKey === 'asis') { let asisItemsHTML = ''; let asisHasActualContent = false; sectionInfo.ids.forEach(id => { const ta = document.getElementById(id); const card = ta ? ta.closest('.card') : null; const subtitle = card ? (card.querySelector('.card-subtitle')?.textContent || card.querySelector('.card-title')?.textContent || '') : ''; const value = ta ? ta.value.trim() : ''; const placeholder = ta ? ta.placeholder : ''; let displayValue = ''; let isPlaceholder = false; if (value) { displayValue = value; asisHasActualContent = true; } else if (placeholder) { displayValue = placeholder; isPlaceholder = true; } if (displayValue) { const contentClass = isPlaceholder ? 'review-content asis-item placeholder-text' : 'review-content asis-item'; asisItemsHTML += `<div class="${contentClass}"><strong>${subtitle.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</strong>${displayValue.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</div>`; sectionHasContent = true; } }); if (!asisHasActualContent && sectionHasContent) { sectionContentHTML = asisItemsHTML + `<div class="review-content placeholder-text">（↑上記は入力例です）</div>`; } else if (!sectionHasContent) { sectionContentHTML += `<div class="review-content placeholder-text">（未入力）</div>`; } else { sectionContentHTML = asisItemsHTML; } } else { const ta = document.getElementById(sectionInfo.ids[0]); const value = ta ? ta.value.trim() : ''; const placeholder = ta ? ta.placeholder : ''; let displayValue = ''; let isPlaceholder = false; if (value) { displayValue = value; } else if (placeholder) { displayValue = placeholder; isPlaceholder = true; } else { displayValue = '（未入力）'; isPlaceholder = true; } const contentClass = isPlaceholder ? 'review-content placeholder-text' : 'review-content'; sectionContentHTML += `<pre class="${contentClass}">${displayValue.replace(/</g, "&lt;").replace(/>/g, "&gt;")}</pre>`; if (value || placeholder) sectionHasContent = true; } summaryHTML += `<div class="review-section"><h4 class="review-section-title">${sectionInfo.title}</h4>${sectionContentHTML}</div>`; }
        reviewSummaryContainer.innerHTML = summaryHTML;
        reviewSummaryContainer.style.display = 'block';
        outputContainer.style.display = "none"; // Ensure image output is hidden initially
        if (generateBtnWrapper) { generateBtnWrapper.style.display = 'block'; } // Show generate button wrapper
        reviewSummaryContainer.scrollIntoView({ behavior: 'smooth', block: 'start' });
        console.log('Review summary displayed.');
    }
    // --- Event Listeners ---
    tabButtons.forEach(button => button.addEventListener('click', () => { const id = button.dataset.tab; if (id) showTab(id); }));
    document.querySelectorAll('.nav-button').forEach(button => { button.addEventListener('click', () => { let nextTabId = null; const isNext = button.classList.contains('next'); const isPrev = button.classList.contains('prev'); const isRestart = button.classList.contains('restart'); if (isNext && !isRestart && currentTabIndex < tabOrder.length - 1) nextTabId = tabOrder[currentTabIndex + 1]; else if (isPrev && currentTabIndex > 0) nextTabId = tabOrder[currentTabIndex - 1]; else if (isRestart) nextTabId = tabOrder[0]; if (nextTabId) { showTab(nextTabId); const ct = document.querySelector('.container').offsetTop; window.scrollTo({ top: ct - 20, behavior: 'smooth' }); } }); });
    if (saveButtonLocal) saveButtonLocal.addEventListener('click', () => { if (isLocalStorageAvailable && saveInputsToLocal()) showNotification(saveNotificationLocal, 2000); });
    if (downloadButton) downloadButton.addEventListener('click', downloadDataAsFile);
    if (uploadButton && fileInput) uploadButton.addEventListener('click', () => fileInput.click());
    if (fileInput) fileInput.addEventListener('change', handleFileUpload);
    if (clearButtonLocal) { clearButtonLocal.addEventListener('click', () => { if (confirm('現在入力されている内容と、ブラウザに保存されているデータがすべて消去されます。よろしいですか？')) { clearAllInputs(); showNotification(clearNotification, 2500); showTab(tabOrder[0]); } }); } else { console.error('Clear button not found.'); }
    let debounceTimer; textareas.forEach(ta => ta.addEventListener('input', () => { clearTimeout(debounceTimer); debounceTimer = setTimeout(saveInputsToLocal, 500); }));
    if (reviewButton) reviewButton.addEventListener('click', displayReviewSummary);

    // --- Generate Image Button Click (Captures ONLY review summary) ---
    if (generateBtn) {
        generateBtn.addEventListener('click', () => {
            if (reviewSummaryContainer.style.display !== 'block') { alert('先に「入力内容をレビュー」ボタンを押してください。'); return; }
            const canWriteToClipboard = navigator.clipboard && typeof navigator.clipboard.write === 'function' && window.isSecureContext;
            if (!canWriteToClipboard) { alert('お使いのブラウザまたは接続環境では、クリップボードへの画像コピー機能が利用できない可能性があります。\n手動での保存・添付をお願いします。（HTTPS接続が必要な場合があります）'); }
            saveInputsToLocal();
            generateBtn.textContent = '画像生成中...'; generateBtn.disabled = true;
            outputImg.src = ''; imageSaveInstruction.innerHTML = ''; // Clear previous output

            const tempContainer = document.createElement('div'); tempContainer.id = 'capture-temp-container';
            const clonedReview = reviewSummaryContainer.cloneNode(true); clonedReview.style.display = 'block'; clonedReview.id = ''; tempContainer.appendChild(clonedReview);
            document.body.appendChild(tempContainer);

            const options = { scale: window.devicePixelRatio || 1.5, useCORS: true, backgroundColor: '#fef9e7', logging: false, scrollX: 0, scrollY: -window.scrollY, windowWidth: tempContainer.scrollWidth, windowHeight: tempContainer.scrollHeight };

            setTimeout(() => {
                 html2canvas(tempContainer, options).then(canvas => {
                     const dataURL = canvas.toDataURL("image/png", 0.95);
                     outputImg.src = dataURL;
                     outputContainer.style.display = "block"; // Show the output container

                     const tweetText = "あるみ式のびしろサイクルでレビュー！ #あるみ式のびしろサイクル";
                     tweetBtn.href = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}`;

                     if (canWriteToClipboard) { try { canvas.toBlob(async (blob) => { if (!blob) throw new Error("Canvas to Blob conversion failed."); try { await navigator.clipboard.write([new ClipboardItem({ 'image/png': blob })]); if (imageSaveInstruction) imageSaveInstruction.innerHTML = `✅ 画像をクリップボードにコピーしました！<br/>ツイート画面を開き、<strong>Ctrl+V (Cmd+V)</strong> で画像を貼り付けてください。<br/><small>(コピーに失敗した場合は下の画像を保存して手動で添付してください)</small>`; console.log('Image copied to clipboard.'); } catch (err) { console.error('Failed to copy image to clipboard:', err); if (imageSaveInstruction) imageSaveInstruction.innerHTML = `クリップボードへのコピーに失敗しました。<br/>📲 <strong>画像を長押しして保存</strong> し、<br/>ツイートに添付して投稿してください。<br/>💻 PC: <strong>右クリック → 名前をつけて画像を保存</strong>`; } }, 'image/png'); } catch (e) { console.error("Error generating blob for clipboard:", e); if (imageSaveInstruction) imageSaveInstruction.innerHTML = `クリップボード処理中にエラー発生。<br/>📲 <strong>画像を長押しして保存</strong> し、<br/>ツイートに添付して投稿してください。<br/>💻 PC: <strong>右クリック → 名前をつけて画像を保存</strong>`; } } else { if (imageSaveInstruction) imageSaveInstruction.innerHTML = `クリップボードコピー非対応/非推奨環境です。<br/>📲 <strong>画像を長押しして保存</strong> し、<br/>ツイートに添付して投稿してください。<br/>💻 PC: <strong>右クリック → 名前をつけて画像を保存</strong>`; }
                     outputContainer.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                     generateBtn.textContent = '🖼️ 画像を再生成/コピー';
                 }).catch(error => {
                     console.error('html2canvas failed:', error);
                     alert('画像の生成に失敗しました。\n内容が複雑すぎる、ブラウザの制限、または予期せぬエラーが発生した可能性があります。\n\n(詳細: ' + error.message + ')');
                     generateBtn.textContent = '🔄 画像生成再試行';
                     outputContainer.style.display = "none"; // Hide output on error
                     if (imageSaveInstruction) imageSaveInstruction.innerHTML = `画像生成エラー。<br/>📲 <strong>画像を長押しして保存</strong> し、<br/>ツイートに添付して投稿してください。<br/>💻 PC: <strong>右クリック → 名前をつけて画像を保存</strong>`;
                 }).finally(() => {
                     if (document.body.contains(tempContainer)) { document.body.removeChild(tempContainer); }
                     generateBtn.disabled = false;
                 });
            }, 250);
        });
    } else { console.error('Generate image button not found.'); }

    // --- Initial Setup ---
    checkLocalStorage();
    restoreInputsFromLocal();
    showTab(tabOrder[0]);
  });
</script>

</body>
</html>
