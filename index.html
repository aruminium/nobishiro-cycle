// ✅ CHECKタブで全入力の一覧を表示し、それを画像化・保存・ツイートできるようにする

import React, { useState, useEffect, useRef } from 'react';
import html2canvas from 'html2canvas';

const ArumiGrowthCycle = () => {
  const [activeTab, setActiveTab] = useState('tobe');
  const [inputs, setInputs] = useState({
    'tobe-input': '',
    'asis-gap': '',
    'asis-challenges': '',
    'asis-emotions': '',
    'asis-constraints': '',
    'asis-past': '',
    'rule-input': '',
    'perk-input': '',
    'action-input': '',
    'check-input': ''
  });
  const [progress, setProgress] = useState(0);
  const [showNotification, setShowNotification] = useState(false);
  const [saveButtonAnimated, setSaveButtonAnimated] = useState(false);
  const [imageUrl, setImageUrl] = useState('');
  const captureRef = useRef(null);
  const summaryRef = useRef(null);

  useEffect(() => {
    let filledCount = 0;
    let totalFields = 0;
    Object.keys(inputs).forEach(key => {
      totalFields++;
      if (inputs[key].trim().length > 0) filledCount++;
    });
    setProgress(Math.round((filledCount / totalFields) * 100));
  }, [inputs]);

  const handleInputChange = (id, value) => {
    setInputs(prev => ({ ...prev, [id]: value }));
  };

  const switchTab = (tabId) => setActiveTab(tabId);

  const handleNavigation = (direction) => {
    const tabOrder = ['tobe', 'asis', 'rule', 'perk', 'action', 'check'];
    const currentIndex = tabOrder.indexOf(activeTab);
    if (direction === 'next' && currentIndex < tabOrder.length - 1) setActiveTab(tabOrder[currentIndex + 1]);
    else if (direction === 'prev' && currentIndex > 0) setActiveTab(tabOrder[currentIndex - 1]);
    else if (direction === 'restart') setActiveTab('tobe');
  };

  const handleSave = () => {
    setSaveButtonAnimated(true);
    setShowNotification(true);
    setTimeout(() => setSaveButtonAnimated(false), 1000);
    setTimeout(() => setShowNotification(false), 2000);
  };

  const handleCapture = async () => {
    if (!summaryRef.current) return;
    const canvas = await html2canvas(summaryRef.current);
    const dataUrl = canvas.toDataURL('image/png');
    setImageUrl(dataUrl);

    const link = document.createElement('a');
    link.href = dataUrl;
    link.download = 'arumi_nobishiro_cycle.png';
    link.click();
  };

  return (
    <div className="bg-pink-50 min-h-screen text-pink-500 p-5 font-sans" ref={captureRef}>
      {/* ...既存UI省略（元のコード保持）... */}

      {activeTab === 'check' && (
        <div className="mt-12 text-center">
          <div ref={summaryRef} className="bg-white border border-pink-200 rounded-xl shadow-md p-6 max-w-3xl mx-auto text-left">
            <h3 className="text-xl font-bold text-pink-500 mb-4">🌸 のびしろ一覧まとめ</h3>
            {Object.entries(inputs).map(([key, value]) => (
              <div key={key} className="mb-4">
                <h4 className="text-base font-semibold text-pink-400 mb-1">{key}</h4>
                <p className="text-sm text-gray-700 whitespace-pre-wrap bg-pink-50 p-3 rounded-lg border border-pink-100">
                  {value || '（未入力）'}
                </p>
              </div>
            ))}
          </div>

          <button
            onClick={handleCapture}
            className="bg-green-500 hover:bg-green-600 text-white px-6 py-3 rounded-full shadow-lg text-lg font-semibold transition-all mt-6"
          >
            📸 画像にする（保存付き）
          </button>

          {imageUrl && (
            <div className="mt-6">
              <img src={imageUrl} alt="のびしろサイクルの記録" className="max-w-full rounded-xl border border-pink-200 shadow-md mx-auto" />
              <p className="text-sm text-pink-500 mt-2">
                📲 スマホの方は<strong>画像を長押し</strong>して保存してね！
              </p>
              <a
                href={`https://twitter.com/intent/tweet?hashtags=%23あるみ式のびしろサイクル&text=のびしろ記録、可視化してみた！`}
                target="_blank"
                rel="noopener noreferrer"
                className="inline-block mt-3 px-4 py-2 bg-blue-400 hover:bg-blue-500 text-white rounded-full shadow text-base"
              >
                ツイートする
              </a>
            </div>
          )}
        </div>
      )}

      {/* Save Button, Notification, Style（元のまま） */}
    </div>
  );
};

export default ArumiGrowthCycle;
